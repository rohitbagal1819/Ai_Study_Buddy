<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StudyBuddy - Quiz Module (User Chooses Timer)</title>
  <link rel="stylesheet" href="shared-styles.css">

  <style>
    /* Use shared variables for consistency */
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
      padding-left: 280px;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    @media (max-width: 1024px) {
      .container { padding-left: 24px; padding-right: 24px; }
    }

    h1 { font-size: 2.1rem; margin-bottom: 1.5rem; color: var(--text-primary); }
    h2, h3 { margin-bottom: 1.25rem; color: var(--text-primary); }

    .filters { display: flex; gap: 12px; margin-bottom: 2rem; flex-wrap: wrap; align-items: center; }
    .filter-btn {
      padding: 10px 20px; border-radius: 9999px; border: 1px solid var(--border-color);
      background: var(--bg-secondary); color: var(--text-secondary); font-weight: 500; cursor: pointer; transition: all 0.18s;
    }
    .filter-btn.active, .filter-btn:hover { background: var(--accent-color); color: white; border-color: var(--accent-color); }

    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem; }
    .stat-card { background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; box-shadow: var(--box-shadow); text-align: center; }
    .stat-value { font-size: 2.25rem; font-weight: 700; margin-bottom: 0.25rem; color: var(--text-primary); }
    .stat-label { color: var(--text-secondary); font-size: 0.95rem; }

    .quiz-list { display: grid; gap: 1.25rem; }
    .quiz-card {
      background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem;
      box-shadow: var(--box-shadow); transition: transform 0.15s, box-shadow 0.15s;
    }
    .quiz-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }

    .quiz-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary); }
    .quiz-meta { display: flex; gap: 1.2rem; font-size: 0.9rem; color: var(--text-secondary); flex-wrap: wrap; }

    .badge {
      padding: 4px 10px; border-radius: 9999px; font-size: 0.8rem; font-weight: 600;
    }
    .badge-subject { background: #e0e7ff; color: #4f46e5; }
    .badge-pending { background: #fef3c7; color: #d97706; }
    .badge-attempted { background: #d1fae5; color: #059669; }
    .badge-created { background: #dbeafe; color: #2563eb; }

    /* Dark mode overrides for badges */
    body.dark-mode .badge-subject { background: #4338ca; color: #e0e7ff; }
    body.dark-mode .badge-pending { background: #b45309; color: #fef3c7; }
    body.dark-mode .badge-attempted { background: #047857; color: #d1fae5; }
    body.dark-mode .badge-created { background: #1d4ed8; color: #dbeafe; }

    .quiz-actions { display: flex; gap: 12px; margin-top: 0.75rem; flex-wrap: wrap; }
    .btn {
      padding: 10px 18px; border-radius: 8px; font-weight: 500; cursor: pointer;
      border: none; transition: all 0.16s;
    }
    .btn-primary { background: var(--accent-color); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
    .btn-outline:hover { background: var(--bg-tertiary); }

    #attempt-screen, #results-screen, #create-screen {
      display: none; background: var(--bg-secondary); padding: 2rem; border-radius: 12px;
      box-shadow: var(--box-shadow);
    }

    .question { margin: 1.5rem 0; padding: 1.5rem; background: var(--bg-tertiary); border-radius: 10px; }
    .options { display: flex; flex-direction: column; gap: 12px; margin-top: 1.2rem; }
    .option {
      padding: 14px 18px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px;
      cursor: pointer; transition: all 0.14s; color: var(--text-primary);
    }
    .option:hover { border-color: var(--accent-color); background: var(--bg-tertiary); }
    .option.selected { border-color: var(--accent-color); background: #e0e7ff; font-weight: 500; color: var(--text-primary); }
    body.dark-mode .option.selected { background: #6366f133; }

    .progress { display: flex; align-items: center; gap: 12px; margin-bottom: 1.5rem; font-size: 0.95rem; color: var(--text-secondary); }
    .progress-bar { flex: 1; height: 8px; background: var(--border-color); border-radius: 999px; }
    .progress-fill { height: 100%; background: var(--accent-color); border-radius: 999px; width: 0; transition: width 0.3s; }

    .nav-buttons { display: flex; justify-content: space-between; margin-top: 2rem; }
    .score-big { font-size: 3.5rem; font-weight: 800; text-align: center; margin: 1rem 0; color: var(--text-primary); }
    .explanation { margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; font-size: 0.95rem; line-height: 1.6; color: var(--text-primary); }

    .form-group { margin-bottom: 1.5rem; }
    label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-primary); }
    input, select {
      width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;
      background: var(--bg-secondary); color: var(--text-primary);
    }
    .question-form { border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; background: var(--bg-tertiary); }
    .option-inputs { display: flex; flex-direction: column; gap: 0.75rem; }
    .option-row { display: flex; gap: 12px; }
    .option-row input { flex: 1; }
    #questions-list { margin-top: 1.5rem; }

    /* Timer display */
    #timer-display {
      font-size: 1.4rem; font-weight: 600; text-align: center; margin: 1rem 0 1.5rem;
      padding: 0.8rem; border-radius: 12px; background: var(--bg-tertiary); color: var(--text-primary);
    }
    #time-remaining.warning { color: var(--pending); }
    #time-remaining.danger { color: var(--red); font-weight: 700; }

    /* Start confirmation overlay */
    #start-confirm {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
      align-items: center; justify-content: center;
    }
    #start-confirm .dialog {
      background: var(--bg-secondary); padding: 2rem; border-radius: 12px; max-width: 420px; width: 90%;
      box-shadow: var(--box-shadow); color: var(--text-primary);
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Quizzes</h1>

  <div class="filters">
    <button class="filter-btn active" data-filter="all">All</button>
    <button class="filter-btn" data-filter="created">Created</button>
    <button class="filter-btn" data-filter="attempted">Attempted</button>
    <button class="filter-btn" data-filter="pending">Pending</button>
    <button class="btn btn-primary" id="create-quiz-btn" style="margin-left: auto;">+ Create Quiz</button>
  </div>

  <div class="stats">
    <div class="stat-card"><div class="stat-value" id="stat-taken">0</div><div class="stat-label">Taken</div></div>
    <div class="stat-card"><div class="stat-value" id="stat-avg">0%</div><div class="stat-label">Avg Score</div></div>
    <div class="stat-card"><div class="stat-value" id="stat-pending">0</div><div class="stat-label">Pending</div></div>
  </div>

  <div class="quiz-list" id="quizList"></div>

  <!-- Attempt Screen -->
  <div id="attempt-screen">
    <button class="btn btn-outline" id="back-to-list">← Back to List</button>
    <h2 id="quiz-title-attempt"></h2>
    <div id="timer-display" style="display:none;">
      Time remaining: <span id="time-remaining">--:--</span>
    </div>
    <div class="progress">
      <div>Question <span id="current-q-num">1</span> of <span id="total-q">?</span></div>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
    </div>
    <div id="current-question"></div>
    <div class="nav-buttons">
      <button class="btn btn-outline" id="prev-q" disabled>Previous</button>
      <button class="btn btn-outline" id="next-q">Next</button>
      <button class="btn btn-primary" id="submit-quiz" style="display:none;">Submit Quiz</button>
    </div>
  </div>

  <!-- Results Screen -->
  <div id="results-screen">
    <button class="btn btn-outline" id="back-from-results">← Back to List</button>
    <h2 id="quiz-title-results"></h2>
    <div class="score-big" id="score-display">--</div>
    <p style="text-align:center; color:var(--text2);">Your Score</p>
    <div id="results-detail"></div>
    <div style="margin-top:2rem; text-align:center;">
      <button class="btn btn-primary" id="reattempt-btn">Re-attempt Quiz</button>
    </div>
  </div>

  <!-- Create Screen -->
  <div id="create-screen">
    <button class="btn btn-outline" id="back-from-create">← Back to List</button>
    <h2>Create New Quiz</h2>
    <div class="form-group">
      <label for="quiz-title">Quiz Title</label>
      <input type="text" id="quiz-title" placeholder="Enter quiz title">
    </div>
    <div class="form-group">
      <label for="quiz-subject">Subject</label>
      <input type="text" id="quiz-subject" placeholder="Enter subject">
    </div>
    <h3>Questions</h3>
    <div id="questions-list"></div>
    <button class="btn btn-outline" id="add-question">+ Add Question</button>
    <div style="margin-top:2rem; text-align:right;">
      <button class="btn btn-primary" id="save-quiz">Save Quiz</button>
    </div>
  </div>

  <!-- Start Confirmation Overlay -->
  <div id="start-confirm">
    <div class="dialog">
      <h3>Ready to start "<span id="confirm-quiz-title"></span>"?</h3>
      <div class="form-group">
        <label>How much time do you want?</label>
        <select id="user-timer-choice">
          <option value="0">Unlimited time</option>
          <option value="5">5 minutes</option>
          <option value="10">10 minutes</option>
          <option value="15">15 minutes</option>
          <option value="20">20 minutes</option>
          <option value="30">30 minutes</option>
          <option value="45">45 minutes</option>
          <option value="60">60 minutes</option>
          <option value="custom">Custom minutes...</option>
        </select>
      </div>
      <div id="custom-time-row" class="form-group" style="display:none;">
        <input type="number" id="custom-timer-min" min="1" max="180" placeholder="Enter minutes (1–180)">
      </div>
      <div style="margin-top:1.8rem; display:flex; gap:12px; justify-content:flex-end;">
        <button class="btn btn-outline" id="cancel-start">Cancel</button>
        <button class="btn btn-primary" id="confirm-start">Start Now</button>
      </div>
    </div>
  </div>
</div>


<script src="shared-component.js"></script>
<script>
// ────────────────────────────────────────────────
// Data (sample quizzes – no fixed timeLimit anymore)
// ────────────────────────────────────────────────
let quizzes = JSON.parse(localStorage.getItem('quizzes')) || [
  {
    id: 1, title: "Biology - Cell Structure", subject: "Biology", created: false,
    questions: [
      { id: 1, text: "Powerhouse of the cell?", options: {A:"Nucleus",B:"Mitochondria",C:"Ribosome",D:"Golgi"}, correct: "B", explanation: "Mitochondria produce ATP." },
      { id: 2, text: "Protein synthesis organelle?", options: {A:"Golgi",B:"Lysosome",C:"Ribosome",D:"ER"}, correct: "C", explanation: "Ribosomes build proteins." },
      { id: 3, text: "Cell membrane function?", options: {A:"Store DNA",B:"Control entry/exit",C:"Energy production",D:"Lipid synthesis"}, correct: "B", explanation: "Selective barrier." }
    ]
  },
  {
    id: 2, title: "Physics - Newton's Laws", subject: "Physics", created: false,
    questions: [
      { id: 1, text: "First Law is?", options: {A:"F=ma",B:"Inertia",C:"Action-Reaction",D:"Gravity"}, correct: "B", explanation: "Object stays at rest or motion unless force acts." },
      { id: 2, text: "F = ma is which law?", options: {A:"First",B:"Second",C:"Third",D:"None"}, correct: "B", explanation: "Newton's Second Law." }
    ]
  }
];

// ────────────────────────────────────────────────
// Save / User data
// ────────────────────────────────────────────────
function saveQuizzes() { localStorage.setItem('quizzes', JSON.stringify(quizzes)); }
function saveUserData() { localStorage.setItem('quizUserData', JSON.stringify(userData)); }

let userData = JSON.parse(localStorage.getItem('quizUserData')) || { saved: [], attempts: {} };

function getStatus(quizId) {
  if (userData.attempts[quizId]?.length > 0) return 'attempted';
  if (userData.saved.includes(quizId)) return 'pending';
  return 'available';
}

function getBestScore(quizId) {
  const attempts = userData.attempts[quizId] || [];
  return attempts.length ? Math.max(...attempts.map(a => a.score)) : null;
}

function updateStats() {
  const attempted = Object.keys(userData.attempts).length;
  const totalScores = Object.values(userData.attempts).flat().map(a => a.score);
  const avg = totalScores.length ? (totalScores.reduce((a,b)=>a+b,0)/totalScores.length).toFixed(0) : 0;
  const pending = userData.saved.filter(id => !userData.attempts[id]).length;

  document.getElementById('stat-taken').textContent = attempted;
  document.getElementById('stat-avg').textContent = avg + '%';
  document.getElementById('stat-pending').textContent = pending;
}

// ────────────────────────────────────────────────
// Render quiz list
// ────────────────────────────────────────────────
function renderQuizzes(filter = "all") {
  const list = document.getElementById("quizList");
  list.innerHTML = "";

  const filtered = quizzes.filter(q => {
    const s = getStatus(q.id);
    if (filter === "all") return true;
    if (filter === "created") return q.created;
    if (filter === "attempted") return s === "attempted";
    if (filter === "pending") return s === "pending";
    return true;
  });

  if (filtered.length === 0) {
    list.innerHTML = `<p style="text-align:center; color:var(--text-secondary); padding:3rem 0;">No quizzes found.</p>`;
    return;
  }

  filtered.forEach(q => {
    const status = getStatus(q.id);
    const best = getBestScore(q.id);
    const att = (userData.attempts[q.id] || []).length;

    const card = document.createElement("div");
    card.className = "quiz-card";
    let badges = "";
    if (q.created) badges += `<span class="badge badge-created">Created</span>`;
    if (status === "pending") badges += `<span class="badge badge-pending">Pending</span>`;
    if (status === "attempted") badges += `<span class="badge badge-attempted">Attempted</span>`;

    card.innerHTML = `
      <div class="quiz-title">${q.title}</div>
      <div class="quiz-meta">
        <span class="badge badge-subject">${q.subject}</span>
        ${badges}
        <span>${q.questions.length} questions</span>
        ${best ? `<span>Best: ${best}%</span>` : ""}
        ${att ? `<span>Attempts: ${att}</span>` : ""}
      </div>
      <div class="quiz-actions">
        ${status === "available" ? `<button class="btn btn-outline save-quiz" data-id="${q.id}">Save for Later</button>` : ""}
        ${status === "pending" ? `
          <button class="btn btn-primary start-quiz" data-id="${q.id}">Start Quiz</button>
          <button class="btn btn-outline remove-pending" data-id="${q.id}">Remove</button>
        ` : ""}
        ${status === "attempted" ? `
          <button class="btn btn-primary view-results" data-id="${q.id}">View Results</button>
          <button class="btn btn-outline reattempt" data-id="${q.id}">Re-attempt</button>
        ` : ""}
        ${q.created ? `
          <button class="btn btn-outline edit-quiz" data-id="${q.id}">Edit</button>
          <button class="btn btn-outline delete-quiz" data-id="${q.id}" style="color:var(--red);">Delete</button>
        ` : ""}
      </div>
    `;
    list.appendChild(card);
  });

  updateStats();
}

// ────────────────────────────────────────────────
// Attempt + Timer logic
// ────────────────────────────────────────────────
let currentQuiz = null;
let currentQuestionIndex = 0;
let userAnswers = {};
let timerInterval = null;
let timeLeftSeconds = 0;
let selectedQuizIdToStart = null;
let userChosenTimeMin = 0;

function cleanupAttemptScreen() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  document.getElementById("attempt-screen").style.display = "none";
  userChosenTimeMin = 0;
}

function updateTimerDisplay() {
  if (timeLeftSeconds <= 0) return;
  const m = Math.floor(timeLeftSeconds / 60);
  const s = timeLeftSeconds % 60;
  const str = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  const el = document.getElementById("time-remaining");
  el.textContent = str;
  el.className = "";
  if (timeLeftSeconds <= 60) el.classList.add("danger");
  else if (timeLeftSeconds <= 180) el.classList.add("warning");
}

function tickTimer() {
  if (timeLeftSeconds <= 0) {
    clearInterval(timerInterval);
    alert("Time's up! Submitting automatically.");
    submitQuiz();
    return;
  }
  timeLeftSeconds--;
  updateTimerDisplay();
}

function startAttempt(quizId, isReattempt = false) {
  currentQuiz = quizzes.find(q => q.id === quizId);
  if (!currentQuiz) return alert("Quiz not found");

  currentQuestionIndex = 0;
  userAnswers = {};

  timeLeftSeconds = userChosenTimeMin ? userChosenTimeMin * 60 : 0;

  if (timeLeftSeconds > 0) {
    document.getElementById("timer-display").style.display = "block";
    updateTimerDisplay();
    timerInterval = setInterval(tickTimer, 1000);
  } else {
    document.getElementById("timer-display").style.display = "none";
  }

  document.getElementById("quizList").style.display = "none";
  document.getElementById("attempt-screen").style.display = "block";
  document.getElementById("quiz-title-attempt").textContent = currentQuiz.title;
  document.getElementById("total-q").textContent = currentQuiz.questions.length;

  renderQuestion();
}

function renderQuestion() {
  const q = currentQuiz.questions[currentQuestionIndex];
  document.getElementById("current-q-num").textContent = currentQuestionIndex + 1;

  let html = `<div class="question"><strong>Question ${currentQuestionIndex + 1}</strong><p>${q.text}</p><div class="options">`;
  for (const [k, v] of Object.entries(q.options)) {
    html += `<div class="option" data-answer="${k}">${k}) ${v}</div>`;
  }
  html += `</div></div>`;

  document.getElementById("current-question").innerHTML = html;

  if (userAnswers[q.id]) {
    document.querySelector(`.option[data-answer="${userAnswers[q.id]}"]`)?.classList.add("selected");
  }

  document.querySelectorAll(".option").forEach(el => {
    el.addEventListener("click", () => {
      document.querySelectorAll(".option").forEach(o => o.classList.remove("selected"));
      el.classList.add("selected");
      userAnswers[q.id] = el.dataset.answer;
    });
  });

  document.getElementById("prev-q").disabled = currentQuestionIndex === 0;
  document.getElementById("next-q").style.display = currentQuestionIndex < currentQuiz.questions.length - 1 ? "block" : "none";
  document.getElementById("submit-quiz").style.display = currentQuestionIndex === currentQuiz.questions.length - 1 ? "block" : "none";

  const prog = ((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100;
  document.getElementById("progress-fill").style.width = prog + "%";
}

// ────────────────────────────────────────────────
// Navigation & Submit
// ────────────────────────────────────────────────
document.getElementById("prev-q")?.addEventListener("click", () => {
  if (currentQuestionIndex > 0) {
    currentQuestionIndex--;
    renderQuestion();
  }
});

document.getElementById("next-q")?.addEventListener("click", () => {
  if (currentQuestionIndex < currentQuiz.questions.length - 1) {
    currentQuestionIndex++;
    renderQuestion();
  }
});

document.getElementById("submit-quiz")?.addEventListener("click", submitQuiz);

function submitQuiz() {
  let correct = 0;
  currentQuiz.questions.forEach(q => {
    if (userAnswers[q.id] === q.correct) correct++;
  });
  const score = Math.round((correct / currentQuiz.questions.length) * 100);

  if (!userData.attempts[currentQuiz.id]) userData.attempts[currentQuiz.id] = [];
  userData.attempts[currentQuiz.id].push({
    score, answers: {...userAnswers}, date: new Date().toISOString(),
    timeUsedMin: userChosenTimeMin ? (userChosenTimeMin - Math.ceil(timeLeftSeconds/60)) : null
  });

  userData.saved = userData.saved.filter(id => id !== currentQuiz.id);
  saveUserData();

  cleanupAttemptScreen();
  showResults(score);
}

function showResults(score) {
  document.getElementById("results-screen").style.display = "block";
  document.getElementById("quiz-title-results").textContent = currentQuiz.title;
  document.getElementById("score-display").textContent = score + "%";
  document.getElementById("score-display").style.color = score >= 80 ? "var(--green)" : score >= 60 ? "var(--pending)" : "var(--red)";

  let html = `<h3 style="margin:1.5rem 0 1rem;">Results Detail</h3>`;
  currentQuiz.questions.forEach(q => {
    const ans = userAnswers[q.id] || "—";
    const isCorrect = ans === q.correct;
    html += `
      <div class="question">
        <strong>${q.text}</strong><br>
        Your answer: <strong style="color:${isCorrect?'var(--green)':'var(--red)'}">${ans}) ${q.options[ans] || "—"}</strong>
        ${isCorrect ? ' ✓ Correct' : ` ✗ Wrong (Correct: ${q.correct})`}
        <div class="explanation">${q.explanation}</div>
      </div>`;
  });
  document.getElementById("results-detail").innerHTML = html;
}

// ────────────────────────────────────────────────
// Create / Edit (removed timeLimit field)
// ────────────────────────────────────────────────
let editingQuizId = null;
let newQuiz = { title: "", subject: "", questions: [] };
let questionCounter = 1;

function startCreate(isEdit = false, quizId = null) {
  document.getElementById("quizList").style.display = "none";
  document.getElementById("create-screen").style.display = "block";

  if (isEdit && quizId) {
    const quiz = quizzes.find(q => q.id === quizId);
    if (quiz) {
      editingQuizId = quizId;
      newQuiz = { ...quiz };
      document.getElementById("quiz-title").value = quiz.title;
      document.getElementById("quiz-subject").value = quiz.subject;
      questionCounter = quiz.questions.length + 1;
      renderNewQuestions();
    }
  } else {
    editingQuizId = null;
    newQuiz = { title: "", subject: "", questions: [] };
    questionCounter = 1;
    document.getElementById("quiz-title").value = "";
    document.getElementById("quiz-subject").value = "";
    renderNewQuestions();
  }
}

function renderNewQuestions() {
  const cont = document.getElementById("questions-list");
  cont.innerHTML = "";
  newQuiz.questions.forEach((q, i) => {
    const div = document.createElement("div");
    div.className = "question-form";
    div.innerHTML = `
      <div class="form-group"><label>Question ${i+1}</label><input type="text" class="q-text" value="${q.text||''}"></div>
      <div class="option-inputs">
        <label>Options</label>
        <div class="option-row"><input class="opt-a" value="${q.options?.A||''}" placeholder="A"><input class="opt-b" value="${q.options?.B||''}" placeholder="B"></div>
        <div class="option-row"><input class="opt-c" value="${q.options?.C||''}" placeholder="C"><input class="opt-d" value="${q.options?.D||''}" placeholder="D"></div>
      </div>
      <div class="form-group">
        <label>Correct Answer</label>
        <select class="correct">
          <option value="A" ${q.correct==='A'?'selected':''}>A</option>
          <option value="B" ${q.correct==='B'?'selected':''}>B</option>
          <option value="C" ${q.correct==='C'?'selected':''}>C</option>
          <option value="D" ${q.correct==='D'?'selected':''}>D</option>
        </select>
      </div>
      <div class="form-group"><label>Explanation</label><input type="text" class="explanation" value="${q.explanation||''}"></div>
      <button class="btn btn-outline remove-q" data-index="${i}" style="color:var(--red);">Remove</button>
    `;
    cont.appendChild(div);
  });
}

document.getElementById("add-question").onclick = () => {
  newQuiz.questions.push({ id: questionCounter++, text:"", options:{A:"",B:"",C:"",D:""}, correct:"A", explanation:"" });
  renderNewQuestions();
};

document.getElementById("save-quiz").onclick = () => {
  newQuiz.title = document.getElementById("quiz-title").value.trim();
  newQuiz.subject = document.getElementById("quiz-subject").value.trim();

  if (!newQuiz.title || !newQuiz.subject || !newQuiz.questions.length) {
    alert("Title, subject and at least 1 question required.");
    return;
  }

  let valid = true;
  document.querySelectorAll(".question-form").forEach((form, i) => {
    const text = form.querySelector(".q-text").value.trim();
    const a = form.querySelector(".opt-a").value.trim();
    const b = form.querySelector(".opt-b").value.trim();
    const c = form.querySelector(".opt-c").value.trim();
    const d = form.querySelector(".opt-d").value.trim();
    const correct = form.querySelector(".correct").value;
    const exp = form.querySelector(".explanation").value.trim();

    if (!text || !a || !b || !c || !d || !exp) { valid = false; return; }

    newQuiz.questions[i] = { ...newQuiz.questions[i], text, options: {A:a,B:b,C:c,D:d}, correct, explanation:exp };
  });

  if (!valid) {
    alert("Please fill all fields for every question.");
    return;
  }

  if (editingQuizId) {
    const idx = quizzes.findIndex(q => q.id === editingQuizId);
    quizzes[idx] = { ...newQuiz, id: editingQuizId, created: true };
  } else {
    newQuiz.id = Math.max(...quizzes.map(q=>q.id||0), 0) + 1;
    newQuiz.created = true;
    quizzes.push(newQuiz);
  }

  saveQuizzes();
  document.getElementById("create-screen").style.display = "none";
  document.getElementById("quizList").style.display = "grid";
  renderQuizzes("created");
};

// ────────────────────────────────────────────────
// Event Listeners
// ────────────────────────────────────────────────
document.addEventListener("click", e => {
  const t = e.target;
  const id = t.dataset.id ? Number(t.dataset.id) : null;

  // Filters
  if (t.matches(".filter-btn")) {
    document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
    t.classList.add("active");
    renderQuizzes(t.dataset.filter);
  }

  // Create
  if (t.id === "create-quiz-btn") startCreate();

  // Save / Remove pending
  if (t.classList.contains("save-quiz")) {
    if (!userData.saved.includes(id)) userData.saved.push(id);
    saveUserData(); renderQuizzes();
  }
  if (t.classList.contains("remove-pending")) {
    userData.saved = userData.saved.filter(sid => sid !== id);
    saveUserData(); renderQuizzes();
  }

  // Start / Reattempt → show timer choice dialog
  if (t.classList.contains("start-quiz") || t.classList.contains("reattempt")) {
    const quiz = quizzes.find(q => q.id === id);
    if (!quiz) return alert("Quiz not found");
    selectedQuizIdToStart = id;
    document.getElementById("confirm-quiz-title").textContent = quiz.title;
    document.getElementById("start-confirm").style.display = "flex";
    document.getElementById("user-timer-choice").value = "0";
    document.getElementById("custom-time-row").style.display = "none";
  }

  // View results
  if (t.classList.contains("view-results")) {
    const attempt = userData.attempts[id]?.slice(-1)[0];
    if (attempt) {
      currentQuiz = quizzes.find(q => q.id === id);
      userAnswers = attempt.answers;
      cleanupAttemptScreen();
      showResults(attempt.score);
    } else {
      alert("No attempt found.");
    }
  }

  // Edit / Delete
  if (t.classList.contains("edit-quiz")) startCreate(true, id);
  if (t.classList.contains("delete-quiz")) {
    if (confirm("Delete this quiz?")) {
      quizzes = quizzes.filter(q => q.id !== id);
      delete userData.attempts[id];
      userData.saved = userData.saved.filter(s => s !== id);
      saveQuizzes(); saveUserData(); renderQuizzes();
    }
  }

  // Remove question in create
  if (t.classList.contains("remove-q")) {
    const idx = Number(t.dataset.index);
    newQuiz.questions.splice(idx, 1);
    renderNewQuestions();
  }

  // Back buttons
  if (t.id === "back-to-list" || t.id === "back-from-results" || t.id === "back-from-create") {
    cleanupAttemptScreen();
    document.getElementById("results-screen").style.display = "none";
    document.getElementById("create-screen").style.display = "none";
    document.getElementById("quizList").style.display = "grid";
    renderQuizzes();
  }

  if (t.id === "reattempt-btn") {
    document.getElementById("results-screen").style.display = "none";
    const quiz = currentQuiz;
    selectedQuizIdToStart = quiz.id;
    document.getElementById("confirm-quiz-title").textContent = quiz.title;
    document.getElementById("start-confirm").style.display = "flex";
    document.getElementById("user-timer-choice").value = "0";
    document.getElementById("custom-time-row").style.display = "none";
  }
});

// Timer choice dialog logic
document.getElementById("user-timer-choice")?.addEventListener("change", function() {
  document.getElementById("custom-time-row").style.display = this.value === "custom" ? "block" : "none";
});

document.getElementById("cancel-start")?.addEventListener("click", () => {
  document.getElementById("start-confirm").style.display = "none";
  selectedQuizIdToStart = null;
});

document.getElementById("confirm-start")?.addEventListener("click", () => {
  if (!selectedQuizIdToStart) return;

  const choice = document.getElementById("user-timer-choice").value;
  let minutes = 0;

  if (choice === "custom") {
    minutes = Number(document.getElementById("custom-timer-min").value) || 0;
    if (minutes < 1 || minutes > 180) {
      alert("Please enter a number between 1 and 180 minutes.");
      return;
    }
  } else {
    minutes = Number(choice);
  }

  userChosenTimeMin = minutes > 0 ? minutes : null;
  document.getElementById("start-confirm").style.display = "none";

  startAttempt(selectedQuizIdToStart);
  selectedQuizIdToStart = null;
});

// Initial load
renderQuizzes("all");
</script>
</body>
</html>